<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒºåŸŸæ ‡å®š Web ç‰ˆ</title>
    <script src="https://unpkg.com/konva@9/konva.min.js"></script>
    <style>
        :root {
            --sidebar-width: 300px;
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --bg-color: #f8f9fa;
            --text-color: #333;
        }
        body { margin: 0; display: flex; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; height: 100vh; overflow: hidden; color: var(--text-color); }
        
        #sidebar {
            width: var(--sidebar-width);
            background: white;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            z-index: 10;
            overflow-y: auto;
        }

        #container {
            flex-grow: 1;
            background: #e9ecef;
            overflow: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        h3 { margin-top: 0; color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        .btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            cursor: pointer;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            transition: background-color 0.2s;
        }
        .btn:hover { background-color: #0056b3; }
        
        .info-box {
            background: #f1f3f5;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.5;
        }

        .region-item {
            padding: 10px;
            border: 1px solid #ddd;
            margin-bottom: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        .region-item:hover { background-color: #f8f9fa; }
        .region-item.active { border-color: var(--primary-color); background-color: #e7f1ff; }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 20px;
            color: #666;
        }
    </style>
</head>
<body>

<div id="sidebar">
    <h3>åŒºåŸŸæ ‡å®šå·¥å…·</h3>
    
    <div class="info-box">
        <strong>æ“ä½œè¯´æ˜ï¼š</strong>
        <ol style="padding-left: 20px; margin: 5px 0;">
            <li><strong>æ‹–æ‹½çº¢ç‚¹</strong>ï¼šè°ƒæ•´å¤šè¾¹å½¢é¡¶ç‚¹ä½ç½®ã€‚</li>
            <li><strong>ç»¿è‰²åŒºåŸŸ</strong>ï¼šåŸºç¡€åŒºåŸŸï¼ˆBase Regionï¼‰ã€‚</li>
            <li><strong>è“è‰²åŒºåŸŸ</strong>ï¼šè¾¹ç¼˜åŒºåŸŸï¼ˆEdge Regionï¼‰ã€‚</li>
            <li><strong>çº¢è‰²åŒºåŸŸ</strong>ï¼šå…¶ä»–å­åŒºåŸŸã€‚</li>
            <li>ä¿®æ”¹å®Œæˆåï¼Œç‚¹å‡»ä¸‹æ–¹<strong>â€œä¿å­˜é…ç½®â€</strong>æŒ‰é’®ã€‚</li>
        </ol>
    </div>

    <button class="btn" onclick="saveToServer()">ğŸ’¾ ä¿å­˜é…ç½®åˆ° YAML</button>
    
    <h3>åŒºåŸŸåˆ—è¡¨</h3>
    <div id="regionList"></div>
</div>

<div id="container"></div>
<div class="loading" id="loading">æ­£åœ¨åŠ è½½å›¾ç‰‡å’Œé…ç½®...</div>

<script>
    const CONFIG_RES = { width: 1408, height: 1024 }; // åŸå§‹åˆ†è¾¨ç‡
    const VIEW_WIDTH = 1024; // ç½‘é¡µæ˜¾ç¤ºå®½åº¦
    const SCALE = VIEW_WIDTH / CONFIG_RES.width;

    const stage = new Konva.Stage({
        container: 'container',
        width: VIEW_WIDTH,
        height: CONFIG_RES.height * SCALE
    });

    const layer = new Konva.Layer();
    stage.add(layer);

    let configData = { base_regions: [] };

    // 1. åŠ è½½èƒŒæ™¯å›¾
    const bgImage = new Image();
    bgImage.onload = function() {
        const konvaImg = new Konva.Image({
            image: bgImage,
            width: stage.width(),
            height: stage.height(),
        });
        layer.add(konvaImg);
        konvaImg.moveToBottom();
        document.getElementById('loading').style.display = 'none';
        loadConfig(); // å›¾ç‰‡åŠ è½½å®Œåå†åŠ è½½é…ç½®
    };
    bgImage.onerror = function() {
        document.getElementById('loading').innerText = "âŒ æ— æ³•åŠ è½½èƒŒæ™¯å›¾ç‰‡ (camera_background.png)";
    };
    bgImage.src = '/camera_background.png'; // ä½¿ç”¨æ ¹è·¯å¾„

    // 2. è·å–é…ç½®
    async function loadConfig() {
        try {
            const res = await fetch('/config');
            configData = await res.json();
            renderRegions();
            renderRegionList();
        } catch (e) {
            console.error("åŠ è½½é…ç½®å¤±è´¥", e);
            alert("åŠ è½½é…ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡");
        }
    }

    // 3. æ¸²æŸ“åŒºåŸŸ
    function renderRegions() {
        // æ¸…é™¤æ—§å›¾å½¢ï¼ˆä¿ç•™èƒŒæ™¯å›¾é™¤å¤–ï¼‰
        layer.getChildren(node => node.getClassName() !== 'Image').forEach(n => n.destroy());

        configData.base_regions.forEach((region, rIdx) => {
            // ç»˜åˆ¶åŸºç¡€åŒºåŸŸ
            drawPolygon(region.polygon_vertices, 'green', `Base: ${region.name}`, (newPoints) => {
                configData.base_regions[rIdx].polygon_vertices = newPoints;
            });
            
            // ç»˜åˆ¶å­åŒºåŸŸ
            region.sub_regions.forEach((sub, sIdx) => {
                const color = sub.type === 'edge' ? 'blue' : 'red';
                drawPolygon(sub.polygon_vertices, color, `Sub: ${sub.name}`, (newPoints) => {
                    configData.base_regions[rIdx].sub_regions[sIdx].polygon_vertices = newPoints;
                });
            });
        });
    }

    // 4. ç»˜åˆ¶å¯äº¤äº’å¤šè¾¹å½¢å‡½æ•°
    function drawPolygon(vertices, color, tooltipText, onUpdate) {
        if (!vertices || vertices.length === 0) return;

        const points = vertices.flatMap(v => [v[0] * SCALE, v[1] * SCALE]);
        
        const group = new Konva.Group();
        layer.add(group);

        const poly = new Konva.Line({
            points: points,
            stroke: color,
            strokeWidth: 2,
            closed: true,
            fill: color === 'green' ? 'rgba(0,255,0,0.1)' : (color === 'blue' ? 'rgba(0,0,255,0.1)' : 'rgba(255,0,0,0.1)'),
        });
        group.add(poly);

        // æ·»åŠ æ–‡æœ¬æ ‡ç­¾
        const text = new Konva.Text({
            x: points[0],
            y: points[1] - 20,
            text: tooltipText,
            fontSize: 14,
            fill: color,
            fontStyle: 'bold'
        });
        group.add(text);

        // ä¸ºæ¯ä¸ªé¡¶ç‚¹åˆ›å»ºæ‰‹æŸ„
        const anchors = [];
        for (let i = 0; i < points.length / 2; i++) {
            const circle = new Konva.Circle({
                x: points[i * 2],
                y: points[i * 2 + 1],
                radius: 6,
                fill: color,
                stroke: 'white',
                strokeWidth: 2,
                draggable: true,
                hitStrokeWidth: 10 // å¢åŠ ç‚¹å‡»åŒºåŸŸ
            });

            circle.on('mouseover', function() {
                document.body.style.cursor = 'pointer';
                this.scale({x: 1.5, y: 1.5});
            });
            
            circle.on('mouseout', function() {
                document.body.style.cursor = 'default';
                this.scale({x: 1, y: 1});
            });

            circle.on('dragmove', () => {
                const p = poly.points();
                p[i * 2] = circle.x();
                p[i * 2 + 1] = circle.y();
                poly.points(p);
                
                // æ›´æ–°æ–‡æœ¬ä½ç½®
                if(i === 0) {
                    text.x(circle.x());
                    text.y(circle.y() - 20);
                }

                // å°†ç¼©æ”¾åçš„åæ ‡è¿˜åŸå¹¶ä¼ å›æ•°æ®æº
                const updatedVertices = [];
                for(let j=0; j<p.length; j+=2) {
                    updatedVertices.push([Math.round(p[j]/SCALE), Math.round(p[j+1]/SCALE)]);
                }
                onUpdate(updatedVertices);
            });
            group.add(circle);
            anchors.push(circle);
        }
    }

    // æ¸²æŸ“å·¦ä¾§åŒºåŸŸåˆ—è¡¨
    function renderRegionList() {
        const listDiv = document.getElementById('regionList');
        listDiv.innerHTML = '';
        
        configData.base_regions.forEach((region, rIdx) => {
            const container = document.createElement('div');
            container.className = 'region-container';
            container.style.marginBottom = '15px';
            container.style.border = '1px solid #ddd';
            container.style.borderRadius = '5px';
            container.style.background = 'white';

            // Base Region Header
            const header = document.createElement('div');
            header.style.padding = '10px';
            header.style.backgroundColor = '#f8f9fa';
            header.style.borderBottom = '1px solid #eee';
            header.innerHTML = `<strong>${region.name}</strong> <span style="color:#666;font-size:0.8em">(${region.region_id})</span>`;
            container.appendChild(header);

            // Sub-regions List
            const subList = document.createElement('div');
            subList.style.padding = '10px';
            
            if (!region.sub_regions || region.sub_regions.length === 0) {
                subList.innerHTML = '<div style="color:#999;font-style:italic;font-size:0.9em">æ— å­åŒºåŸŸ</div>';
            } else {
                region.sub_regions.forEach((sub, sIdx) => {
                    const subItem = document.createElement('div');
                    subItem.style.display = 'flex';
                    subItem.style.justifyContent = 'space-between';
                    subItem.style.alignItems = 'center';
                    subItem.style.marginBottom = '5px';
                    subItem.style.fontSize = '14px';
                    subItem.style.padding = '5px';
                    subItem.style.backgroundColor = '#fff';
                    subItem.style.borderBottom = '1px solid #eee';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.innerHTML = `<span style="color:${sub.type === 'edge' ? 'blue' : 'red'}">â—</span> ${sub.name}`;
                    subItem.appendChild(nameSpan);

                    const delBtn = document.createElement('button');
                    delBtn.innerText = 'Ã—';
                    delBtn.style.border = 'none';
                    delBtn.style.background = 'none';
                    delBtn.style.color = '#dc3545';
                    delBtn.style.cursor = 'pointer';
                    delBtn.style.fontWeight = 'bold';
                    delBtn.style.fontSize = '16px';
                    delBtn.title = 'åˆ é™¤å­åŒºåŸŸ';
                    delBtn.onclick = (e) => {
                        e.stopPropagation();
                        deleteSubRegion(rIdx, sIdx);
                    };
                    subItem.appendChild(delBtn);
                    
                    subList.appendChild(subItem);
                });
            }
            container.appendChild(subList);

            // Add Button
            const addBtn = document.createElement('button');
            addBtn.className = 'btn';
            addBtn.style.margin = '0';
            addBtn.style.borderRadius = '0 0 5px 5px';
            addBtn.style.fontSize = '14px';
            addBtn.style.padding = '8px';
            addBtn.innerHTML = '+ æ·»åŠ å­åŒºåŸŸ';
            addBtn.onclick = () => addSubRegion(rIdx);
            container.appendChild(addBtn);

            listDiv.appendChild(container);
        });
    }

    // æ·»åŠ å­åŒºåŸŸ
    function addSubRegion(rIdx) {
        const name = prompt("è¯·è¾“å…¥æ–°å­åŒºåŸŸçš„åç§°ï¼š");
        if (!name) return;
        
        const region = configData.base_regions[rIdx];
        if (!region.sub_regions) region.sub_regions = [];

        // é»˜è®¤ä½ç½®ï¼šåŸºäºåŸºç¡€åŒºåŸŸçš„ç¬¬ä¸€ä¸ªç‚¹ï¼Œæˆ–è€…é»˜è®¤å€¼
        let startX = 100, startY = 100;
        if (region.polygon_vertices && region.polygon_vertices.length > 0) {
            startX = region.polygon_vertices[0][0] + 50;
            startY = region.polygon_vertices[0][1] + 50;
        }

        const newSub = {
            sub_region_id: `${region.region_id}_sub_${Date.now()}`,
            name: name,
            type: 'custom',
            polygon_vertices: [
                [startX, startY],
                [startX + 100, startY],
                [startX + 100, startY + 100],
                [startX, startY + 100]
            ],
            layer_index: null,
            edge_vector: null
        };

        region.sub_regions.push(newSub);
        renderRegions();
        renderRegionList();
    }

    // åˆ é™¤å­åŒºåŸŸ
    function deleteSubRegion(rIdx, sIdx) {
        if(confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå­åŒºåŸŸå—ï¼Ÿ')) {
            configData.base_regions[rIdx].sub_regions.splice(sIdx, 1);
            renderRegions();
            renderRegionList();
        }
    }

    // 5. ä¿å­˜åˆ°æœåŠ¡å™¨
    async function saveToServer() {
        try {
            const btn = document.querySelector('button[onclick="saveToServer()"]');
            const originalText = btn.innerText;
            btn.innerText = "æ­£åœ¨ä¿å­˜...";
            btn.disabled = true;

            const response = await fetch('/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(configData)
            });
            const result = await response.json();
            
            if(result.status === 'success') {
                alert('âœ… ä¿å­˜æˆåŠŸï¼');
            } else {
                alert('âŒ ä¿å­˜å¤±è´¥');
            }
            
            btn.innerText = originalText;
            btn.disabled = false;
        } catch (e) {
            console.error(e);
            alert('âŒ ä¿å­˜è¯·æ±‚å‡ºé”™');
            document.querySelector('button[onclick="saveToServer()"]').disabled = false;
        }
    }
</script>

</body>
</html>
